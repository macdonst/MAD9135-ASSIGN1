var data;var contactdata;var tap=document.createEvent("Event");tap.initEvent("tap",true,true);var app={initialize:function(){this.bindEvents();console.log('initialize');},bindEvents:function(){console.log('bindEvents');document.addEventListener('deviceready',this.onDeviceReady,false);},onDeviceReady:function(){console.log('onDeviceReady');app.receivedEvent('deviceready');},receivedEvent:function(){console.log('receivedEvent');var networkState=navigator.connection.type;var states={};states[Connection.UNKNOWN]='Unknown connection';states[Connection.ETHERNET]='Ethernet connection';states[Connection.WIFI]='WiFi connection';states[Connection.CELL_2G]='Cell 2G connection';states[Connection.CELL_3G]='Cell 3G connection';states[Connection.CELL_4G]='Cell 4G connection';states[Connection.CELL]='Cell generic connection';states[Connection.NONE]='No network connection';alert('Connection type: '+states[networkState]);if(states[networkState]!='No network connection'){document.addEventListener("online",app.checkData,false);sim.goOnline();console.log(states[networkState]);}else{document.addEventListener("offline",app.offline,false);sim.goOffline();console.log(states[networkState]);}},checkData:function(){console.log('checkData');if(localStorage){var oldCantact=localStorage.getItem("cantactDone");if(oldCantact!=null){app.findContact();console.log("loadLocal");}else{app.loadJson();console.log("loadJson");}}},loadJson:function(){console.log('loadJson');var request=new XMLHttpRequest();request.open('GET','https://dl.dropboxusercontent.com/u/887989/MAD9135/contacts.json',true);request.onreadystatechange=function(){if(request.readyState===4){if(request.status===200||request.status===0){var contactJson=JSON.parse(request.responseText);localStorage.setItem("cantactDone",'1');for(var i=0;i<contactJson.length;i++){var contact=navigator.contacts.create();contact.displayName=contactJson[i].firstname;contact.nickname=contactJson[i].firstname;var name=new ContactName();name.givenName=contactJson[i].firstname;name.familyName=contactJson[i].lastname;var addresses=[];addresses[0]=new ContactAddress('type','home','streetAddress',contactJson[i].street,contactJson[i].city,' ',' ',contactJson[i].state);var phoneNumbers=[];phoneNumbers[0]=new ContactField('mobile',contactJson[i].phone);var emails=[];emails[0]=new ContactField('home',contactJson[i].email);contact.name=name;contact.phoneNumbers=phoneNumbers;contact.addresses=addresses;contact.emails=emails;contact.save(app.onSaveSuccess,app.onSaveError);}}}};request.send();setTimeout(function(){app.findContact();},800);},findContact:function(){var options=new ContactFindOptions();var fields=["displayName","name"];navigator.contacts.find(fields,app.findContactSuccess,app.findContactError,options);},findContactSuccess:function(contacts){var contactNameList=$('.contactName li');if(contactNameList){$('.contactName li').remove();}for(var i=0;i<contacts.length;i++){$('.contactName').append("<li data-i='"+i+"'><a href='#'>"+contacts[i].name.givenName+" "+contacts[i].name.familyName+"</a></li>");}contactdata=contacts;console.log(contactdata);if(app.detectTouchSupport()){$('li').bind('touchend',app.handleTouchEnd);$('li').bind('tap',app.showDetails);}else{$('li').bind('click',app.showDetails);}},showDetails:function(){data=$(this).attr("data-i");$('#frontPage').attr('class','hide');$('#informationPage').attr('class','show');var infoForm=$('.infoForm');if(infoForm){$('.infoForm').remove();}$('#informationPage').append('<form class="infoForm"></form');var input='<div class="formbox">';input+='<label for= "firstname" >firstname : </label>';input+='<input type="text" name="firstname" value="'+contactdata[data].name.givenName+'">';input+='<label for= "lastname" >lastname : </label>';input+='<input type="text" name="lastname" value="'+contactdata[data].name.familyName+'">';for(var i=0;i<contactdata[data].addresses.length;i++){input+='<label for= "street" >street : </label>';input+='<input type="text" name="street" value="'+contactdata[data].addresses[i].streetAddress+'">';input+='<label for= "city" >city : </label>';input+='<input type="text" name="city" value="'+contactdata[data].addresses[i].locality+'">';input+='<label for= "state" >state: </label>';input+='<input type="text" name="state" value="'+contactdata[data].addresses[i].country+'">';}if(contactdata[data].phoneNumbers.length!=0){for(var i=0;i<contactdata[data].phoneNumbers.length;i++){input+='<label for= "phone" >phone: </label>';input+='<input type="text" name="phone" value='+contactdata[data].phoneNumbers[i].value+'>';}}else{input+='<label for= "phone" >phone: </label>';input+='<input type="text" name="phone" value="">';}for(var i=0;i<contactdata[data].emails.length;i++){input+='<label for= "email" >email: </label>';input+='<input type="text" name="email" value="'+contactdata[data].emails[i].value+'">';}input+='</div>';input+='<button class="editbtn" type="button">Edit</button>'input+='<button class="backbtn" type="button">back</button>'$('.infoForm').append(input);if(app.detectTouchSupport()){$('.editbtn, .backbtn').bind('touchend',app.handleTouchEnd);$('.editbtn').bind('tap',app.editinfo);$('.backbtn').bind('tap',app.backToFront);}else{$('.editbtn').bind('click',app.editinfo);$('.backbtn').bind('click',app.backToFront);}},editinfo:function(ev){ev.preventDefault();var currentContact=JSON.parse(localStorage.getItem("currentCantact"));var inputLength=$('input').length
contactdata[data].name.givenName=$('input:eq(0)').val();contactdata[data].name.familyName=$('input:eq(1)').val();contactdata[data].addresses[0].streetAddress=$('input:eq(2)').val();contactdata[data].addresses[0].locality=$('input:eq(3)').val();contactdata[data].addresses[0].country=$('input:eq(4)').val();contactdata[data].emails[0].value=$('input:eq(6)').val();contactdata[data].save(app.onSaveSuccess,app.onSaveError);},backToFront:function(){$('#informationPage').attr('class','hide');$('#frontPage').attr('class','show');app.findContact();},loadLocal:function(){var currentContact=JSON.parse(localStorage.getItem("currentCantact"));var contactName=$('.contactName');if(contactName){$('.contactName').remove();}$('#frontPage').append('<ul class="contactName"></ul>');for(var i=0;i<currentContact.length;i++){$('.contactName').append("<li data-i='"+i+"'><a href='#'>"+currentContact[i].firstname+" "+currentContact[i].lastname+"</a></li>");}if(app.detectTouchSupport()){$('li').bind('touchend',app.handleTouchEnd);$('li').bind('tap',app.showDetails);}else{$('li').bind('click',app.showDetails);}},offline:function(){alert('offLine');},findContactError:function(contactError){alert('onError!');},handleTouchEnd:function(ev){ev.preventDefault();var target=ev.currentTarget;target.dispatchEvent(tap);},detectTouchSupport:function(){msGesture=navigator&&navigator.msPointerEnabled&&navigator.msMaxTouchPoints>0&&MSGesture;touchSupport=(("ontouchstart"in window)||msGesture||(window.DocumentTouch&&document instanceof DocumentTouch));return touchSupport;},onSaveSuccess:function(contact){console.log("Save Success");},onSaveError:function(contactError){console.log("Error = "+contactError.code);}};(function init(){app.initialize();})();